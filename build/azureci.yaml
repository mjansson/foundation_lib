trigger:
- master

pr:
- master
- develop

jobs:
- job: Linux
  pool:
    vmImage: 'ubuntu-16.04'

  steps:
  - task: NuGetToolInstaller@0

  - script: |
      ls /opt/hostedtoolcache/NuGet/4.3.0/x64
    displayName: 'nuget check'

  - script: |
      nuget sources Add -Name "Tools" -Source "https://mjansson.pkgs.visualstudio.com/_packaging/Tools/nuget/v2" -Username mjansson -Password $(System.AccessToken)
    displayName: 'nuget setup'

  - script: |
      nuget install ninja -Source "Tools" -ExcludeVersion
    displayName: 'install ninja'

  - script: |
      python configure.py
    displayName: 'configure'

  - script: |
      ninja/linux/ninja
    displayName: 'build'

  #- script: |
  #    bin\linux\debug\x86-64\test-all
  #  displayName: 'run tests (debug)'

  - script: |
      bin\linux\release\x86-64\test-all
    displayName: 'run tests (release)'

  - script: |
      bin\linux\deploy\x86-64\test-all
    displayName: 'run tests (deploy)'

- job: Windows
  pool:
    vmImage: 'VS2017-Win2016'

  steps:
  - task: NuGetToolInstaller@0

  - script: |
      nuget sources Add -Name "Tools" -Source "https://mjansson.pkgs.visualstudio.com/_packaging/Tools/nuget/v2" -Username mjansson -Password $(System.AccessToken)
    displayName: 'nuget setup'

  - script: |
      nuget install ninja -Source "Tools" -ExcludeVersion
    displayName: 'install ninja'

  - script: |
      python configure.py
    displayName: 'configure'

  - script: |
      ninja\windows\ninja
    displayName: 'build'

  #- script: |
  #    bin\windows\debug\x86-64\test-all.exe
  #  displayName: 'run tests (debug)'

  - script: |
      bin\windows\release\x86-64\test-all.exe
    displayName: 'run tests (release)'

  - script: |
      bin\windows\deploy\x86-64\test-all.exe
    displayName: 'run tests (deploy)'
